<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Insightful Verse - AiBot</title>
  <th:block th:replace="~{common/sub/iviep/iviep-common.html}"></th:block>
  <style>
    body {
      background-color: #0071C5; /* Intel科技蓝 */
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem 2rem;
      min-height: 0;
    }
    #chat-history {
      flex: 1;
      background: #C4C4C4; /* 介于浅灰色和灰色之间 */
      border: 1px solid #ced4da;
      border-radius: 10px;
      padding: 1rem;
      overflow-y: auto;
      font-family: monospace;
    }
    /* Custom Scrollbar Styles */
    #chat-history::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    #chat-history::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    #chat-history::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 10px;
    }
    #chat-history::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    .message {
      margin-bottom: 0.25rem;
    }
    .user {
      font-weight: bold;
      color: #0d6efd;
    }
    .ai {
      font-weight: bold;
      color: #198754;
    }
    .content {
      white-space: pre-wrap;
      margin-left: 0.5rem;
      display: inline-block;
      line-height: 1.4;
    }
    .input-area {
      padding: 1rem 2rem;
      background: #C0C0C0; /* 介于浅灰色和灰色之间 */
      border-top: 1px solid #ced4da;
      display: flex;
      align-items: flex-start;
    }
    .input-area textarea {
      flex: 1;
      resize: none;
      min-height: 3rem;
      max-height: 10rem;
      overflow-y: hidden;
      margin-right: 1rem;
      padding: 0.5rem 0.75rem;
      line-height: 1.5;
      box-sizing: border-box;
    }
    .input-area button {
      margin-left: 0.5rem;
      align-self: flex-end;
      margin-bottom: 0.375rem;
    }
  </style>
</head>
<body>
<th:block th:replace="~{common/sub/iviep/iviep-header-intel.html}"></th:block>

<div class="chat-container">
  <div id="chat-history"></div>
</div>

<div class="input-area">
  <textarea id="prompt" class="form-control" placeholder="Type your message..."></textarea>
  <button class="btn btn-primary" onclick="sendPrompt()">Send</button>
  <button class="btn btn-danger" onclick="clearResponse()">Clear</button>
  <button class="btn btn-secondary" onclick="exportChat()">Export Chat</button>
</div>

<script>
  const promptEl = document.getElementById("prompt");
  const initialMinHeight = window.getComputedStyle(promptEl).minHeight;

  promptEl.addEventListener("input", function() {
    this.style.height = 'auto';
    let scrollHeight = this.scrollHeight;
    const maxHeight = parseInt(window.getComputedStyle(this).maxHeight, 10);

    if (maxHeight && scrollHeight > maxHeight) {
      this.style.height = maxHeight + 'px';
      this.style.overflowY = 'auto';
    } else {
      const minHeightVal = parseInt(initialMinHeight, 10);
      if (scrollHeight < minHeightVal) {
        this.style.height = initialMinHeight;
      } else {
        this.style.height = scrollHeight + 'px';
      }
      this.style.overflowY = 'hidden';
    }
  });

  async function sendPrompt() {
    const text = promptEl.value.trim();
    if (!text) return;

    promptEl.value = "";
    promptEl.style.height = initialMinHeight;
    promptEl.style.overflowY = 'hidden';

    const chatHistory = document.getElementById("chat-history");

    const userDiv = document.createElement("div");
    userDiv.className = "message";
    const userTextNode = document.createTextNode(text);
    const userPrefix = document.createElement("span");
    userPrefix.className = "user";
    userPrefix.textContent = "You: ";
    const userContent = document.createElement("span");
    userContent.className = "content";
    userContent.appendChild(userTextNode);
    userDiv.appendChild(userPrefix);
    userDiv.appendChild(userContent);
    chatHistory.appendChild(userDiv);

    const aiDiv = document.createElement("div");
    aiDiv.className = "message";
    const aiContentId = "ai-" + Date.now();
    const aiPrefix = document.createElement("span");
    aiPrefix.className = "ai";
    aiPrefix.textContent = "AiBot: ";
    const aiContentSpan = document.createElement("span");
    aiContentSpan.className = "content";
    aiContentSpan.id = aiContentId;
    aiDiv.appendChild(aiPrefix);
    aiDiv.appendChild(aiContentSpan);
    chatHistory.appendChild(aiDiv);

    chatHistory.scrollTop = chatHistory.scrollHeight;

    try {
      const res = await fetch("/stream_generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: text, stream: true, max_tokens: 2048 })
      });

      const contentEl = document.getElementById(aiContentId);
      if (!res.ok) {
        contentEl.textContent = "[Error connecting to AI: " + res.status + " " + res.statusText + "]";
        return;
      }

      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        contentEl.textContent += decoder.decode(value, { stream: true });
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }
    } catch (error) {
      const contentEl = document.getElementById(aiContentId);
      if (contentEl) {
        contentEl.textContent = "[Error during AI communication: " + error.message + "]";
      } else {
        console.error("Failed to display AI error, content element not found.");
      }
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }
  }

  function clearResponse() {
    document.getElementById("chat-history").innerHTML = "";
  }

  function exportChat() {
    const chatHistory = document.getElementById("chat-history");
    let chatContent = "";
    const messages = chatHistory.children;

    for (let i = 0; i < messages.length; i++) {
      const messageElement = messages[i];
      const speakerElement = messageElement.querySelector(".user, .ai");
      const contentElement = messageElement.querySelector(".content");

      if (speakerElement && contentElement) {
        let speakerText = speakerElement.textContent;
        if (!speakerText.endsWith(" ")) speakerText += " ";
        chatContent += speakerText + contentElement.textContent + "\n\n";
      }
    }

    if (chatContent.trim() === "") {
      alert("Nothing to export!");
      return;
    }

    const blob = new Blob([chatContent], { type: "text/plain;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    const timestamp = new Date().toISOString().replace(/:/g, "-").slice(0, 19);
    a.download = `chat-export-${timestamp}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
  }

  document.getElementById("prompt").addEventListener("keydown", function(event) {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      sendPrompt();
    }
  });
</script>
</body>
</html>